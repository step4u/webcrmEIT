<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coretree.defaultconfig.main.mapper.MonitoringMapper">
	
  	
    <resultMap id="resultMap" type="com.coretree.defaultconfig.main.model.Monitoring">
        <result property="totIbCnt"			column="tot_ib_count" />
        <result property="totAgtConnCnt"		column="tot_agent_conn_count" />
        <result property="totAbanCnt"			column="tot_aban_count" />
        <result property="totAgtIbCnt"			column="tot_agent_ib_count" />
        <result property="totAgtObCnt"			column="tot_agent_ob_count" />
        <result property="agtIbCnt"			column="agent_ib_count" />
        <result property="agtObCnt"			column="agent_ob_count" />
        <result property="agtCbCounCnt"			column="agent_cb_coun_count" />
        <result property="totCbCounCnt"			column="tot_cb_coun_count" />
        <result property="totCbResCnt"				column="tot_cb_res_count" />
        <result property="agtRevCounCnt"				column="agent_rev_coun_count" />
        <result property="totRevCounCnt"			column="tot_rev_coun_count" />
        <result property="totRevResCnt"			column="tot_rev_res_count" />
        <result property="agtRevResCnt"		column="agent_rev_res_count" />
        <result property="totBbsCnt"		column="TOT_BBS_COUNT" />
    </resultMap>
	
    <select id="selectMonitoringList" parameterType="com.coretree.defaultconfig.main.model.Organization"  resultMap="resultMap">
		select 
			    tot_ib_count                	
			    , tot_agent_conn_count   
			    , ( tot_ib_count - tot_agent_conn_count - tot_cb_res_count ) as tot_aban_count   
			    , tot_agent_ib_count       
			    , tot_agent_ob_count      	
			    , agent_ib_count           
			    , agent_ob_count          
			    , agent_cb_coun_count	
			    , tot_cb_coun_count  	
			    , tot_cb_res_count   	
			     , agent_rev_coun_count
			     , tot_rev_coun_count  
			    , tot_rev_res_count   	
			    , agent_rev_res_count  
			    , TOT_BBS_COUNT        
			 from 
			(    select 
			              tot_ib_count            
			            , tot_agent_conn_count    
			            , tot_agent_ib_count      
			            , tot_agent_ob_count      
			            , agent_ib_count          
			            , agent_ob_count          
			    from (
			        select     
			              COALESCE( sum( case when ( caller_type	=	2	and callee_type	=	0 ) then 1 else 0 end ), 0 ) as tot_ib_count   		
			            , COALESCE( sum( case when ( caller_type	=	2	and callee_type	=	0 	and result	=	5000	and callee_human_name	<![CDATA[<>	'IVR']]>  ) 	then 1   else 0 end ), 0) as tot_agent_conn_count   
			            , COALESCE( sum( case when ( caller_type	=	2	and callee_type	=	0 ) then 1 else 0 end ), 0 ) as tot_agent_ib_count   
			            , COALESCE( sum( case when ( caller_type	=	0	and callee_type	=	2 ) then 1 else 0 end ), 0 ) as tot_agent_ob_count   
			            , COALESCE( sum( case when ((caller_type	=	2	and callee_type	=	0 ) and EMP_NO = #{empNo} ) then 1 else 0 end ), 0 ) as agent_ib_count		
			            , COALESCE( sum( case when ((caller_type	=	0	and callee_type	=	2 ) and EMP_NO = #{empNo} ) then 1 else 0 end ), 0 ) as agent_ob_count		
			        from cdr 
			        where   startdate between cast( (SUBSTRING(CURRENT_DATE FROM 1 FOR 10) ) || ' ' || ( '00:00:00' ) as timestamp ) and current_timestamp
			        )		
			) a,
			(   select 
					 tot_cb_res_count   			
			      , tot_cb_coun_count  		
			      , agent_cb_coun_count		
			      , tot_rev_res_count   	
			      , tot_rev_coun_count  	
			      , agent_rev_res_count   
			      , agent_rev_coun_count	
			    from (
			        SELECT 
			              COALESCE( sum( case when ( RES_DATE   =	replace( SUBSTRING(CURRENT_DATE  FROM 1 FOR 10), '-', '' ) ) then 1 else 0 end ), 0 ) as tot_cb_res_count   
			            , COALESCE( sum( case when ( COUN_DATE  =	replace( SUBSTRING(CURRENT_DATE  FROM 1 FOR 10), '-', '' ) ) then 1 else 0 end ), 0 ) as tot_cb_coun_count  
			            , COALESCE( sum( case when ( COUN_DATE  =	replace( SUBSTRING(CURRENT_DATE  FROM 1 FOR 10), '-', '' ) and  EMP_NO = #{empNo} ) then 1 else 0 end ), 0 ) as  agent_cb_coun_count
			        FROM TCALLBACK
			        where RES_DATE >= replace( SUBSTRING(CURRENT_DATE - 7 FROM 1 FOR 10), '-', '' )
			        ) a2,	
			        (    
			       SELECT 
			              COALESCE( sum( case when ( RES_DATE   =	replace( SUBSTRING(CURRENT_DATE  FROM 1 FOR 10), '-', '' ) ) then 1 else 0 end ), 0 ) as tot_rev_res_count   	
			            , COALESCE( sum( case when ( COUN_DATE  =	replace( SUBSTRING(CURRENT_DATE  FROM 1 FOR 10), '-', '' ) ) then 1 else 0 end ), 0 ) as tot_rev_coun_count  	
			            , COALESCE( sum( case when ( RES_DATE   =	replace( SUBSTRING(CURRENT_DATE  FROM 1 FOR 10), '-', '' ) and  EMP_NO = #{empNo} ) then 1 else 0 end ), 0 ) as agent_rev_res_count  
			            , COALESCE( sum( case when ( COUN_DATE  =	replace( SUBSTRING(CURRENT_DATE  FROM 1 FOR 10), '-', '' ) and  EMP_NO = #{empNo} ) then 1 else 0 end ), 0 ) as agent_rev_coun_count
			        FROM TRESERVATION
			        where RES_DATE >= replace( SUBSTRING(CURRENT_DATE - 7 FROM 1 FOR 10), '-', '' )
			        ) b2		
			) b,
			(   SELECT 
			        count(*) as TOT_BBS_COUNT
			    FROM TBBS_MGT 
			    where REG_DATE = replace( SUBSTRING(CURRENT_DATE FROM 1 FOR 10), '-', '' )
			) c

    </select>
    
</mapper>